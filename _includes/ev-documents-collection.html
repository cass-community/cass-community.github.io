{% comment %}
    CHANGES FROM DEFAULT DOCUMENTS-COLLECTION INCLUDE
    * Call ev-archive-single.html include
    * Accept a `cutoff` parameter to specify when to end the list of events
      - For upcoming events (forward sort_order), cutoff is the oldest date to include
      - For past events (reverse sort_order), cutoff is the newest date to include
    * Add "no events found" message as appropriate
    * Accept a `limit` parameter to show at most that number of events
    * Accept a `more_url` parameter to link a message that there are unshown events
    * Accept a `show_time` parameter to show the event time (default: false) 
    * Accept a `show_registration` parameter to show a registration button (default: false)

    TODO
    * We do not yet support the idea of parent events (e.g. Supercomputing)
      as on the IDEAS website

  Interpreting dates:
    Definitions: s = startdate, e = enddate, c = cutoff
    Situation            Result    Inequalities	   Enddate absent
    s--e c               past      s < c, e < c    s < c
    c s--e               upcoming  s >= c, e >= c  s >= c
    s-c-e (in progress)  upcoming  s < c, e >= c   impossible

  An event can be considered to be past iff both startdate and enddate are in the past. 
  If there is an endate we have to check it to be certain the event is not in progress 
  (which we interpret as upcoming because there are still some dates upcoming).
{% endcomment %}

{% assign entries = include.entries | default: site[include.collection] | where_exp: "post", "post.hidden != true" %}
{% assign limit = include.limit | default: entries.size %}

{% if include.show_time %}
  {% assign show_time = true %}
{% else %}
  {% assign show_time = false %}
{% endif %}
{% if include.show_registration %}
  {% assign show_registration = true %}
{% else %}
  {% assign show_registration = false %}
{% endif %}

{% comment %}
  Trim events to cutoff
{% endcomment %}
{% if include.cutoff %}
  {% if include.sort_order == "reverse" %}
    {% assign enddate = entries | where_exp: "item", "item.enddate != nil" | where_exp: "item", "item.enddate < include.cutoff" %}
    {% assign noenddate = entries | where_exp: "item", "item.enddate == nil" | where_exp: "item", "item.startdate < include.cutoff" %}
  {% else %}
    {% assign enddate = entries | where_exp: "item", "item.enddate != nil" | where_exp: "item", "item.enddate >= include.cutoff" %}
    {% assign noenddate = entries | where_exp: "item", "item.enddate == nil" | where_exp: "item", "item.startdate >= include.cutoff" %}
  {% endif %}
  {% assign entries = enddate | concat: noenddate %}
{% endif %}


{% comment %}
  If the input and/or filtering leave the list of entries empty
  the sorting process will fail.  So instead we just issue a message.
{% endcomment %}

{% if entries != nil and entries.size > 0 %}
  {% if include.sort_by %}
    {% assign entries = entries | sort: include.sort_by %}
  {% endif %}

  {% if include.sort_order == 'reverse' %}
    {% assign entries = entries | reverse %}
  {% endif %}
{% else %}
  <div style="display: flex">
    {% comment %}
      Position the message where event titles are displayed.
      The widith of the empty <div> should match that in
      ev-archive-single.html
    {% endcomment %}
    <div style="width: 25%">
    </div>
    <div>
      <p><em>no events found</em></p>
    </div>
  </div>
{% endif %}

{% comment %}
  If we're showing times, we want events on the same day to appear ordered in time.
  So we use the Jekyll group_by filter to access each day's events and sort them.

  Note that even if we're display events in reverse order by date, I think that the
  times within the date need to be in forward order.  So that's what we do.  Fortunately,
  the group_by filter will take things in the order it finds them, so if we sort the whole
  array before this, we'll get the result we desire.

  However, because we generally use 12 hour time representation, just sorting on the `time`
  field won't give correct results.  So we need to convert the times in the `time` field
  to 24 hour representation.  We ignore timezones.

  There should be no spaces between the minutes and the meridian for this to work properly.
{% endcomment %}

{% if show_time %}
  {% assign entries_by_date = entries | group_by: "startdate" %}
  {% assign entries = "" | split: "," %}{% comment %} We will reconstruct `entries` {% endcomment %}

  {% comment %}
    For each day, look at all of the items

    Create an array `ta` of strings containing the following:
      * The 24 hour representation of start and end times
      * The index of the item
    Note that the dash is irrelevant to this purpose and we ignore the timezone.

    Sort the array, so it is ordered by time.  If start times are the same, end times
    will define the result.  If both times are the same, then the index would define
    the result, but that's fine.
    
    Loop over the sorted times and extract the index.
    Use the indices to add the items to `entries` in the sorted order.
  {% endcomment %}
  {% for e in entries_by_date %}
    {% assign tsort = "" | split: "," %}
    {% for i in e.items %}
      {% assign ta = i.time | split: " "  %}
      {% capture tandi %}times {{ ta[0] | date: "%T" }} {{ ta[2] | date: "%T" }} {{ forloop.index0 }}{% endcapture %}
      {% assign tsort = tsort | push: tandi %}
    {% endfor %}
    {% assign tsort = tsort | sort %}
    {% for tandi in tsort %}
      {% comment %}
        The only thing we care about now is the index in e.items
        associated with the ordered entries.  Note that when we
        extract it, it is initially a string and needs to be
        converted to an integer (by doing a math operation on it)
      {% endcomment %}
      {% assign i = tandi | split: " " | last | plus: 0 %}
      {% assign entries = entries | push: e.items[i] %}
    {% endfor %}
  {% endfor %}
{% endif %}

{%- for post in entries limit: limit -%}
  {% include ev-archive-single.html type=include.type show_time=show_time show_registration=show_registration %}
{%- endfor -%}
{% assign remaining = entries.size | minus: limit %}
{% if remaining > 0 %}
  <div style="display: flex">
  {% comment %}
    Position the message where event titles are displayed.
    The widith of the empty <div> should match that in
    ev-archive-single.html
  {% endcomment %}
  {% if include.more_url %}
      {% capture message %}<a href='{{ include.more_url }}'>see {{remaining }} more {{ remaining | pluralize: "event", "events" }}</a>{% endcapture %}
  {% else %}
      {% capture message %}plus {{remaining }} more {{ remaining | pluralize: "event", "events" }} not shown{% endcapture %}
  {% endif %}
  <div style="width: 25%">
  </div>
  <div>
    <p><em>{{ message }}</em></p>
  </div>
</div>
{% endif %}